---
label: Database
title: TossPayments의 대한 깊은 고찰
subTitle: 결제는 몇번의 검증이 들어가야 좋을까?
date: 2024.06.06
mins: 20
tags: [Toss, TossPayments, 결제연동, PG사, 보안]
imageUrl:
---

## TossPayments

[전자결제대행사](https://namu.wiki/w/%EA%B2%B0%EC%A0%9C%EB%8C%80%ED%96%89%EC%82%AC) 
(PG / Payment Gateway)는 이커머스 결제 지불 대행 서비스를 진행하는 중개업체를 이르는 말인데,  
**토스페이먼츠, KG이니시스, NHN KCP** 이 3개 업체가 가장 높은 점유율을 차지한다.

나는 가장 점유율이 높고, 개발자센터를 통해 쉽고 간편하게 연동할 수 있는 토스페이먼츠를 사용해보기로 했다.

---

## 결제 프로세스와 검증

![1](/posts/deep/tossPayments/toss_payments.png "토스페이먼츠 결제 과정")
토스페이먼츠(*이하토스)의 결제 과정은 다음과같다.

1. 토스페이먼츠에서 제공하는 결제위젯을 화면에 전시
2. 결제하기로 요청
3. 사용자 결제
4. 결제승인 API요청
5. 성공, 실패 Url로 리다이렉트

이 일련의 과정속에서 가장 중요한건 MITM을 막고 데이터의 무결성을 훼손하지 않는일일 것이다.

---

## 접근 방법

### 1
1번에서 백엔드로 결제ID와 금액, 몇가지 구매정보를 보내 DB와 비교후 저장한다. 이를 통해 1차 가격변조를 막고 주문가능 상태를 한번 더 확인한다.

[토스페이먼츠에서 제공하는 결제창 진입 직전에 백엔드와의 통신이 일어나지만, JWT만 있다면 포스트맨으로도 접근이 가능하다.]

[결제ID를 현재시간 + 금액등을 조합해 Hash하여 백엔드로 보내 다시 검증한다면 포스트맨 등의 엔드포인트 접근을 막을 수 있을 것 같다.]

### 2-1
1번에서 추가로 결제창 진입과 동시에 기존의 상품 갯수를 줄여놓고 페이지이탈(새로고침, 브라우저 닫기, 결제창 닫기 등)시
beforeunload과 sendBeacon을 통해 상품의 갯수를 롤백 하는 방식을 택하려 했으나, 브라우저 호환성이나 결제가 완료되고 리다이렉트 되는 경우에도 롤백하는 경우가 생긴다.

[롤백이 될때 추가로 백엔드와 통신하게 되는데 만약 포스트맨으로 이 롤백을 실행한다면, 상품갯수를 줄이고 주문을 추가로 넣을 수 있다.]

[1번과 동일하게 Hash하여 백엔드로 보내 1번에서 저장한 데이터와 비교한다고해도 DB원본에 대한 접근횟수가 너무 많아진다.]

### 2-2
2-1과 같은 문제를 해결하기 위해 롤백을 실행하는 일을 백엔드 자체에 맡길 수 있다. 1번에서 저장한 데이터에 status를 추가하여,
결제가 완료를 판단 백엔드에서 1분간격으로 롤백을 진행하여 DB에 반영한다.

[실시간성은 하락하고 백엔드의 부하는 늘어난다. 또 사실상 DB접근 빈도가 2-1보다 많을 가능성도 있다.]

### 2-3
가장 좋은 방법은 백엔드에게 결제를 맡기는 일이다. successUrl을 직접 백엔드 엔드포인트로 연결,
구매정보비교 -> 주문가능 상태 확인 -> 상품 갯수 줄이기 -> 결제 -> 성공 / 실패시 롤백의 순으로 진행하면 된다.
DB접근 횟수도 줄어들고, 실시간성도 보장된다.

---

## 최종 설계 모델

![2](/posts/deep/tossPayments/toss_payments_arch.png "토스페이먼츠 설계")

- 2-3은 successUrl을 받고 결제 승인 API를 보내기 전에 서버에서 처리된다.










