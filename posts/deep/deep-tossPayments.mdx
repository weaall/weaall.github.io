---
label: Database
title: TossPayments의 대한 깊은 고찰
subTitle: 결제는 몇번의 검증이 들어가야 좋을까?
date: 2024.06.06
mins: 20
tags: [Toss, TossPayments, 결제연동, PG사, 보안]
imageUrl:
---

## TossPayments

[전자결제대행사](https://namu.wiki/w/%EA%B2%B0%EC%A0%9C%EB%8C%80%ED%96%89%EC%82%AC) 
(PG / Payment Gateway)는 이커머스 결제 지불 대행 서비스를 진행하는 중개업체를 이르는 말인데,  
**토스페이먼츠, KG이니시스, NHN KCP** 이 3개 업체가 가장 높은 점유율을 차지한다.

나는 가장 점유율이 높고, 개발자센터를 통해 쉽고 간편하게 연동할 수 있는 토스페이먼츠를 사용해보기로 했다.

---

## 결제 프로세스와 검증

![1](/posts/deep/tossPayments/toss_payments.png "토스페이먼츠 결제 과정")
토스페이먼츠(*이하토스)의 결제 과정은 다음과같다.

1. 토스페이먼츠에서 제공하는 결제위젯을 화면에 전시
2. 결제하기로 요청
3. 사용자 결제
4. 결제승인 API요청
5. 성공, 실패 Url로 리다이렉트

이 일련의 과정속에서 가장 중요한건 MITM을 막고 데이터의 무결성을 훼손하지 않는일일 것이다. 

**첫번째 검증**
토스에서는 successUrl에서 실질적인 결제가 이루어진다. 
때문에 successUrl로 가기전(1번), 변조를 막기위해 백엔드로 금액과 결제ID를 백으로 보내둘것을 권장한다.
이 과정에서 1차적으로 변조를 막을 수 있다. 금액과 상품을 매칭시키는 첫번째 단계이다. 
페이지 자체 내에서의 상품 금액이 변조되었을 경우 백엔드에서 검증 후 에러를 반환하므로 결제를 진행할 수 없다.
추가로 이 과정에서 재고를 줄여놓아서 오버부킹이 안되게 해놓았다. 

[해결필요]
- 결제를 요청한 상태에서 페이지 이탈(뒤로가기, 창끄기)시 해결이 필요하다. 그냥 위젯창을 껏을 때는 쿠키도 지우고 백엔드 데이터를 지울 수 있는데, 이탈시에는 어렵다.

**두번째 검증**
코드에 따르면 failUrl로 향하는건 결제 요청자체를 실패했을 경우와, 
successUrl에서 결제승인 API를 통해 에러를 반환받았을 때이다.
결국 1번 검증과정에서 줄어들었던 재고는 후자의 경우에 2번이나 4번에서 원상 복귀되어야 한다.

[해결필요]
- 2번에서 결제성공시 토스에서 보내주는 res와 백에있는 기존의 금액과 결제ID를 비교할 필요가 있을까? 불일치시 결제를 취소하는 방법을 생각중.

**세번째 검증**
3번에서 결제가 완료되면 결제내역을 백엔드로 보내저장해야 한다. 
토스에서 보낸 response 에서 금액을 따로 빼와 결제내역과 함께 백으로 보내면 기존에 데이터베이스에 존재하던 결제ID와 금액을 비교, 
동일하면 결제성공을 알리고 맞지 않다면 결제 취소를 날려야한다.

[해결필요]
- 백엔드에서 DB에 대한 접근이 과다해질 수 있다. 1번에서 검증이 됐다면 굳이? 싶다. 토스자체가 parmas로 금액을 넘기는데도 불구하고, 페이먼트키를 결제마다 다르게 만들기때문에 크게 문제가 없을 수 있다.





