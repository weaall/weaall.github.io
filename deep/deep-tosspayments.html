<!DOCTYPE html><html lang="kr"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="preload" as="image" href="../../assets/svg/user_icon.svg"/><link rel="preload" as="image" href="../../assets/svg/menu_icon.svg"/><link rel="preload" as="image" href="../../assets/svg/search_icon.svg"/><link rel="preload" as="image" href="../../assets/svg/calendar_icon.svg"/><link rel="preload" as="image" href="../../assets/svg/book_icon.svg"/><link rel="preload" as="image" href="/posts/deep/tossPayments/toss_payments.png"/><link rel="preload" as="image" href="/posts/deep/tossPayments/toss_payments_arch.png"/><link rel="stylesheet" href="/_next/static/css/92f2fa493c2ab7ac.css" crossorigin="" data-precedence="next"/><link rel="stylesheet" href="/_next/static/css/ab1880f3bbfff898.css" crossorigin="" data-precedence="next"/><link rel="preload" as="script" fetchPriority="low" href="/_next/static/chunks/webpack-caeda5e065ac8831.js" crossorigin=""/><script src="/_next/static/chunks/fd9d1056-b78abccdcf7e09a8.js" async="" crossorigin=""></script><script src="/_next/static/chunks/938-57e9749fe7baaed3.js" async="" crossorigin=""></script><script src="/_next/static/chunks/main-app-7faaf895136a49f7.js" async="" crossorigin=""></script><script src="/_next/static/chunks/250-70e21483a8ac042a.js" async=""></script><script src="/_next/static/chunks/662-3ff164d45cbaa71a.js" async=""></script><script src="/_next/static/chunks/app/layout-b038f8d4f6a0f11c.js" async=""></script><script src="/_next/static/chunks/app/not-found-a16bd453cc118838.js" async=""></script><meta name="naver-site-verification" content="e782934088f4524e1d46947402328d9864f04318"/><meta name="google-site-verification" content="EB5qLPhkvA7mD6Yz6VpiZaMErWP4KIB7Aj_rR-xqdsA"/><title>TossPayments의 대한 깊은 고찰</title><meta name="description" content="결제는 몇번의 검증이 들어가야 좋을까?"/><link rel="canonical" href="https://weaall.github.io/"/><meta property="og:title" content="Weaall&#x27;s Dive"/><meta property="og:description" content="Weaall&#x27;s pretty personal idea"/><meta property="og:url" content="https://weaall.github.io/"/><meta property="og:site_name" content="Weaall&#x27;s Dive"/><meta property="og:image" content="https://weaall.github.io/profile.png"/><meta property="og:image:alt" content="Weaall&#x27;s Dive"/><meta property="og:type" content="website"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:title" content="Weaall&#x27;s Dive"/><meta name="twitter:description" content="Weaall&#x27;s pretty personal idea"/><meta name="twitter:image" content="https://weaall.github.io/profile.png"/><meta name="twitter:image:alt" content="Weaall&#x27;s Dive"/><script src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js" crossorigin="" noModule=""></script></head><body class="__className_e662c1"><div class="mx-auto text-main"><div class="mx-auto max-w-[1080px] h-auto p-6"><div class="max-w-[1080px] w-full pt-8 pb-12 flex items-center justify-between text-lg font-bold text-t-main"><a class="bg-main min-w-14 h-12 mx-3 rounded-3xl group" href="/"><img alt="" src="../../assets/svg/user_icon.svg" class="w-8 h-full m-auto group-hover:scale-110"/></a><nav class="flex w-4/5 justify-between items-center"><nav class="w-[80%] px-6 duration-1000 bg-main h-12 mx-2 flex relative rounded-3xl text-centerjustify-between transition-all ease-in"><button class="invisible opacity-0 w-[0px] px-3 py-2 absolute transition-all ease-in duration-500 delay-500"><img alt="" src="../../assets/svg/menu_icon.svg" class="w-8 hover:scale-110"/></button><div class="visible opacity-1 delay-1000 min-w-auto w-full transition-all ease-in duration-100 text-center m-auto"><a class="hover:after:text-red-500 after:content-[&#x27;.&#x27;] after:text-transparent mobile:text-[8px]" href="/shallow">SHALLOW</a></div><div class="visible opacity-1 delay-1000 min-w-auto w-full transition-all ease-in duration-100 text-center m-auto"><a class="hover:after:text-red-500 after:content-[&#x27;.&#x27;] after:text-transparent mobile:text-[8px]" href="/deep">DEEP</a></div><div class="visible opacity-1 delay-1000 min-w-auto w-full transition-all ease-in duration-100 text-center m-auto"><a class="hover:after:text-red-500 after:content-[&#x27;.&#x27;] after:text-transparent mobile:text-[8px]" href="/prac">PRAC</a></div><div class="visible opacity-1 delay-1000 min-w-auto w-full transition-all ease-in duration-100 text-center m-auto"><a class="hover:after:text-red-500 after:content-[&#x27;.&#x27;] after:text-transparent mobile:text-[8px]" href="/project">PROJECT</a></div></nav><div class="w-14 duration-500 bg-main h-12 p-2 rounded-3xl flex justify-between transition-all ease-in"><input class="invisible w-[0px] duration-100 bg-transparent text-xl transition-all outline-none ease-in" value=""/><button class=""><img alt="" src="../../assets/svg/search_icon.svg" class="min-w-10 m-auto hover:scale-110"/></button></div></nav><button class="bg-main min-w-14 h-12 mx-3 rounded-3xl group"><a href="/dev"><p class="mb-1 text-base group-hover:scale-105">dev</p></a></button></div><div class="pb-20"><div class="w-full bg-main h-96 rounded-lg"><img class=""/></div><div class="py-16 space-y-4 border-b-2"><h1 class="text-3xl text-main font-bold after:content-[&#x27;.&#x27;] after:text-red-500">TossPayments의 대한 깊은 고찰</h1><p class="text-xl">결제는 몇번의 검증이 들어가야 좋을까?</p><div class="flex h-auto"><img alt="" src="../../assets/svg/calendar_icon.svg" class="w-4 mr-3"/><p class="text-sm text-main mr-10">2024.06.06</p><img alt="" src="../../assets/svg/book_icon.svg" class="w-4 mr-3"/><p class="text-sm text-main mr-10">20<!-- -->mins</p></div><div class="flex space-x-3 h-auto"><div class="mt-2 text-xs bg-[#eeeeee] px-2 py-1 rounded-lg cursor-pointer">Toss</div><div class="mt-2 text-xs bg-[#eeeeee] px-2 py-1 rounded-lg cursor-pointer">TossPayments</div><div class="mt-2 text-xs bg-[#eeeeee] px-2 py-1 rounded-lg cursor-pointer">결제연동</div><div class="mt-2 text-xs bg-[#eeeeee] px-2 py-1 rounded-lg cursor-pointer">PG사</div><div class="mt-2 text-xs bg-[#eeeeee] px-2 py-1 rounded-lg cursor-pointer">보안</div></div></div></div><h2 class="text-2xl font-bold mt-0 mb-9 after:content-[&#x27;.&#x27;] after:text-red-500 cursor-pointer"><a href="#TossPayments">TossPayments</a></h2>
<p class="text-lg py-3"><a target="_blank" href="https://namu.wiki/w/%EA%B2%B0%EC%A0%9C%EB%8C%80%ED%96%89%EC%82%AC" class="text-lg font-bold text-red-500">전자결제대행사</a>
(PG / Payment Gateway)는 이커머스 결제 지불 대행 서비스를 진행하는 중개업체를 이르는 말인데,<br/>
<strong class="font-bold">토스페이먼츠, KG이니시스, NHN KCP</strong> 이 3개 업체가 가장 높은 점유율을 차지한다.</p>
<p class="text-lg py-3">나는 가장 점유율이 높고, 개발자센터를 통해 쉽고 간편하게 연동할 수 있는 토스페이먼츠를 사용해보기로 했다.</p>
<hr class="my-20 w-full h-[2px] bg-t-main"/>
<h2 class="text-2xl font-bold mt-0 mb-9 after:content-[&#x27;.&#x27;] after:text-red-500 cursor-pointer"><a href="#결제 프로세스와 검증">결제 프로세스와 검증</a></h2>
<p class="text-lg py-3"><div class="w-full mx-auto py-6 text-center"><img src="/posts/deep/tossPayments/toss_payments.png" class="mx-auto"/><p class="text-xs text-gray-400">토스페이먼츠 결제 과정</p></div>
토스페이먼츠(*이하토스)의 결제 과정은 다음과같다.</p>
<ol>
<li class="pl-6 py-2 text-lg before:content-[&#x27;-&#x27;] before:font-bold before:pr-3">토스페이먼츠에서 제공하는 결제위젯을 화면에 전시</li>
<li class="pl-6 py-2 text-lg before:content-[&#x27;-&#x27;] before:font-bold before:pr-3">결제하기로 요청</li>
<li class="pl-6 py-2 text-lg before:content-[&#x27;-&#x27;] before:font-bold before:pr-3">사용자 결제</li>
<li class="pl-6 py-2 text-lg before:content-[&#x27;-&#x27;] before:font-bold before:pr-3">결제승인 API요청</li>
<li class="pl-6 py-2 text-lg before:content-[&#x27;-&#x27;] before:font-bold before:pr-3">성공, 실패 Url로 리다이렉트</li>
</ol>
<p class="text-lg py-3">이 일련의 과정속에서 가장 중요한건 MITM을 막고 데이터의 무결성을 훼손하지 않는일일 것이다.</p>
<hr class="my-20 w-full h-[2px] bg-t-main"/>
<h2 class="text-2xl font-bold mt-0 mb-9 after:content-[&#x27;.&#x27;] after:text-red-500 cursor-pointer"><a href="#접근 방법">접근 방법</a></h2>
<h3 class="text-xl font-bold mt-9 mb-6">1</h3>
<p class="text-lg py-3">1번에서 백엔드로 결제ID와 금액, 몇가지 구매정보를 보내 DB와 비교후 저장한다. 이를 통해 1차 가격변조를 막고 주문가능 상태를 한번 더 확인한다.</p>
<p class="text-lg py-3">[토스페이먼츠에서 제공하는 결제창 진입 직전에 백엔드와의 통신이 일어나지만, JWT만 있다면 포스트맨으로도 접근이 가능하다.]</p>
<p class="text-lg py-3">[결제ID를 현재시간 + 금액등을 조합해 Hash하여 백엔드로 보내 다시 검증한다면 포스트맨 등의 엔드포인트 접근을 막을 수 있을 것 같다.]</p>
<h3 class="text-xl font-bold mt-9 mb-6">2-1</h3>
<p class="text-lg py-3">1번에서 추가로 결제창 진입과 동시에 기존의 상품 갯수를 줄여놓고 페이지이탈(새로고침, 브라우저 닫기, 결제창 닫기 등)시
beforeunload과 sendBeacon을 통해 상품의 갯수를 롤백 하는 방식을 택하려 했으나, 브라우저 호환성이나 결제가 완료되고 리다이렉트 되는 경우에도 롤백하는 경우가 생긴다.</p>
<p class="text-lg py-3">[롤백이 될때 추가로 백엔드와 통신하게 되는데 만약 포스트맨으로 이 롤백을 실행한다면, 상품갯수를 줄이고 주문을 추가로 넣을 수 있다.]</p>
<p class="text-lg py-3">[1번과 동일하게 Hash하여 백엔드로 보내 1번에서 저장한 데이터와 비교한다고해도 DB원본에 대한 접근횟수가 너무 많아진다.]</p>
<h3 class="text-xl font-bold mt-9 mb-6">2-2</h3>
<p class="text-lg py-3">2-1과 같은 문제를 해결하기 위해 롤백을 실행하는 일을 백엔드 자체에 맡길 수 있다. 1번에서 저장한 데이터에 status를 추가하여,
결제가 완료를 판단 백엔드에서 1분간격으로 롤백을 진행하여 DB에 반영한다.</p>
<p class="text-lg py-3">[실시간성은 하락하고 백엔드의 부하는 늘어난다. 또 사실상 DB접근 빈도가 2-1보다 많을 가능성도 있다.]</p>
<h3 class="text-xl font-bold mt-9 mb-6">2-3</h3>
<p class="text-lg py-3">가장 좋은 방법은 백엔드에게 결제를 맡기는 일이다. successUrl을 직접 백엔드 엔드포인트로 연결,
구매정보비교 -&gt; 주문가능 상태 확인 -&gt; 상품 갯수 줄이기 -&gt; 결제 -&gt; 성공 / 실패시 롤백의 순으로 진행하면 된다.
DB접근 횟수도 줄어들고, 실시간성도 보장된다.</p>
<hr class="my-20 w-full h-[2px] bg-t-main"/>
<h2 class="text-2xl font-bold mt-0 mb-9 after:content-[&#x27;.&#x27;] after:text-red-500 cursor-pointer"><a href="#최종 설계 모델">최종 설계 모델</a></h2>
<p class="text-lg py-3"><div class="w-full mx-auto py-6 text-center"><img src="/posts/deep/tossPayments/toss_payments_arch.png" class="mx-auto"/><p class="text-xs text-gray-400">토스페이먼츠 설계</p></div></p>
<ul>
<li class="pl-6 py-2 text-lg before:content-[&#x27;-&#x27;] before:font-bold before:pr-3">2-3은 successUrl을 받고 결제 승인 API를 보내기 전에 서버에서 처리된다.</li>
</ul></div><div class="w-full border-t mt-20 text-t-main"><div class="mx-auto max-w-[1080px] h-40 justify-between flex mobile:flex-col mobile:h-52"><div class="flex flex-col m-auto text-center space-y-1 w-[33%]"><p class="font-bold text-2xl">Dong-Hyun Wi</p><p class="text-sm">weaall@naver.com</p><p class="text-sm">weaall88@gmail.com</p></div><div class="flex flex-col m-auto text-center space-y-1 w-[33%]"><img alt="" src="../../assets/svg/user_icon.svg" class="w-8 h-full m-auto group-hover:scale-110"/></div><div class="flex m-auto space-x-4 w-[33%] justify-center"><a href="/" class="font-bold text-base">Main</a><a href="/shallow" class="font-bold text-base">Shallow</a><a href="/deep" class="font-bold text-base">Deep</a><a href="/" class="font-bold text-base">Me</a></div></div></div></div><script src="/_next/static/chunks/webpack-caeda5e065ac8831.js" crossorigin="" async=""></script><script>(self.__next_f=self.__next_f||[]).push([0]);self.__next_f.push([2,null])</script><script>self.__next_f.push([1,"1:HL[\"/_next/static/css/92f2fa493c2ab7ac.css\",\"style\",{\"crossOrigin\":\"\"}]\n2:HL[\"/_next/static/css/ab1880f3bbfff898.css\",\"style\",{\"crossOrigin\":\"\"}]\n0:\"$L3\"\n"])</script><script>self.__next_f.push([1,"4:I[7690,[],\"\"]\n7:I[5613,[],\"\"]\n9:I[1778,[],\"\"]\na:I[7709,[\"250\",\"static/chunks/250-70e21483a8ac042a.js\",\"662\",\"static/chunks/662-3ff164d45cbaa71a.js\",\"185\",\"static/chunks/app/layout-b038f8d4f6a0f11c.js\"],\"\"]\nb:I[8667,[\"160\",\"static/chunks/app/not-found-a16bd453cc118838.js\"],\"\"]\nd:I[8955,[],\"\"]\n8:[\"slug\",\"deep-tosspayments\",\"d\"]\n"])</script><script>self.__next_f.push([1,"3:[[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/92f2fa493c2ab7ac.css\",\"precedence\":\"next\",\"crossOrigin\":\"\"}],[\"$\",\"link\",\"1\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/ab1880f3bbfff898.css\",\"precedence\":\"next\",\"crossOrigin\":\"\"}]],[\"$\",\"$L4\",null,{\"buildId\":\"veTt12V_z-zvca9y6Nwsf\",\"assetPrefix\":\"\",\"initialCanonicalUrl\":\"/deep/deep-tosspayments\",\"initialTree\":[\"\",{\"children\":[\"(pages)\",{\"children\":[\"deep\",{\"children\":[[\"slug\",\"deep-tosspayments\",\"d\"],{\"children\":[\"__PAGE__?{\\\"slug\\\":\\\"deep-tosspayments\\\"}\",{}]}]}]}]},\"$undefined\",\"$undefined\",true],\"initialSeedData\":[\"\",{\"children\":[\"(pages)\",{\"children\":[\"deep\",{\"children\":[[\"slug\",\"deep-tosspayments\",\"d\"],{\"children\":[\"__PAGE__\",{},[\"$L5\",\"$L6\",null]]},[\"$\",\"$L7\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"(pages)\",\"children\",\"deep\",\"children\",\"$8\",\"children\"],\"loading\":\"$undefined\",\"loadingStyles\":\"$undefined\",\"loadingScripts\":\"$undefined\",\"hasLoading\":false,\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L9\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\",\"styles\":null}]]},[\"$\",\"$L7\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"(pages)\",\"children\",\"deep\",\"children\"],\"loading\":\"$undefined\",\"loadingStyles\":\"$undefined\",\"loadingScripts\":\"$undefined\",\"hasLoading\":false,\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L9\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\",\"styles\":null}]]},[\"$\",\"$L7\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"(pages)\",\"children\"],\"loading\":\"$undefined\",\"loadingStyles\":\"$undefined\",\"loadingScripts\":\"$undefined\",\"hasLoading\":false,\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L9\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\",\"styles\":null}]]},[null,[\"$\",\"html\",null,{\"lang\":\"kr\",\"children\":[[\"$\",\"head\",null,{\"children\":[[\"$\",\"meta\",null,{\"name\":\"naver-site-verification\",\"content\":\"e782934088f4524e1d46947402328d9864f04318\"}],[\"$\",\"meta\",null,{\"name\":\"google-site-verification\",\"content\":\"EB5qLPhkvA7mD6Yz6VpiZaMErWP4KIB7Aj_rR-xqdsA\"}]]}],[\"$\",\"body\",null,{\"className\":\"__className_e662c1\",\"children\":[\"$\",\"div\",null,{\"children\":[[\"$\",\"div\",null,{\"children\":[[\"$\",\"$La\",null,{}],[\"$\",\"$L7\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\"],\"loading\":\"$undefined\",\"loadingStyles\":\"$undefined\",\"loadingScripts\":\"$undefined\",\"hasLoading\":false,\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L9\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":[\"$\",\"$Lb\",null,{}],\"notFoundStyles\":[],\"styles\":null}]],\"style\":{},\"className\":\"mx-auto max-w-[1080px] h-auto p-6\"}],[\"$\",\"div\",null,{\"children\":[\"$\",\"div\",null,{\"children\":[[\"$\",\"div\",null,{\"children\":[[\"$\",\"p\",null,{\"children\":\"Dong-Hyun Wi\",\"style\":{},\"className\":\"font-bold text-2xl\"}],[\"$\",\"p\",null,{\"children\":\"weaall@naver.com\",\"style\":{},\"className\":\"text-sm\"}],[\"$\",\"p\",null,{\"children\":\"weaall88@gmail.com\",\"style\":{},\"className\":\"text-sm\"}]],\"style\":{},\"className\":\"flex flex-col m-auto text-center space-y-1 w-[33%]\"}],[\"$\",\"div\",null,{\"children\":[\"$\",\"img\",null,{\"alt\":\"\",\"src\":\"../../assets/svg/user_icon.svg\",\"style\":{},\"className\":\"w-8 h-full m-auto group-hover:scale-110\"}],\"style\":{},\"className\":\"flex flex-col m-auto text-center space-y-1 w-[33%]\"}],[\"$\",\"div\",null,{\"children\":[[\"$\",\"a\",null,{\"href\":\"/\",\"children\":\"Main\",\"style\":{},\"className\":\"font-bold text-base\"}],[\"$\",\"a\",null,{\"href\":\"/shallow\",\"children\":\"Shallow\",\"style\":{},\"className\":\"font-bold text-base\"}],[\"$\",\"a\",null,{\"href\":\"/deep\",\"children\":\"Deep\",\"style\":{},\"className\":\"font-bold text-base\"}],[\"$\",\"a\",null,{\"href\":\"/\",\"children\":\"Me\",\"style\":{},\"className\":\"font-bold text-base\"}]],\"style\":{},\"className\":\"flex m-auto space-x-4 w-[33%] justify-center\"}]],\"style\":{},\"className\":\"mx-auto max-w-[1080px] h-40 justify-between flex mobile:flex-col mobile:h-52\"}],\"style\":{},\"className\":\"w-full border-t mt-20 text-t-main\"}]],\"style\":{},\"className\":\"mx-auto text-main\"}]}]]}],null]],\"initialHead\":[false,\"$Lc\"],\"globalErrorComponent\":\"$d\"}]]\n"])</script><script>self.__next_f.push([1,"6:[[\"$\",\"div\",null,{\"children\":[[\"$\",\"div\",null,{\"children\":[\"$\",\"img\",null,{\"style\":{},\"className\":\"\"}],\"style\":{},\"className\":\"w-full bg-main h-96 rounded-lg\"}],[\"$\",\"div\",null,{\"children\":[[\"$\",\"h1\",null,{\"children\":\"TossPayments의 대한 깊은 고찰\",\"style\":{},\"className\":\"text-3xl text-main font-bold after:content-['.'] after:text-red-500\"}],[\"$\",\"p\",null,{\"children\":\"결제는 몇번의 검증이 들어가야 좋을까?\",\"style\":{},\"className\":\"text-xl\"}],[\"$\",\"div\",null,{\"children\":[[\"$\",\"img\",null,{\"alt\":\"\",\"src\":\"../../assets/svg/calendar_icon.svg\",\"style\":{},\"className\":\"w-4 mr-3\"}],[\"$\",\"p\",null,{\"children\":\"2024.06.06\",\"style\":{},\"className\":\"text-sm text-main mr-10\"}],[\"$\",\"img\",null,{\"alt\":\"\",\"src\":\"../../assets/svg/book_icon.svg\",\"style\":{},\"className\":\"w-4 mr-3\"}],[\"$\",\"p\",null,{\"children\":[20,\"mins\"],\"style\":{},\"className\":\"text-sm text-main mr-10\"}]],\"style\":{},\"className\":\"flex h-auto\"}],[\"$\",\"div\",null,{\"children\":[[\"$\",\"div\",null,{\"children\":\"Toss\",\"style\":{},\"className\":\"mt-2 text-xs bg-[#eeeeee] px-2 py-1 rounded-lg cursor-pointer\"}],[\"$\",\"div\",null,{\"children\":\"TossPayments\",\"style\":{},\"className\":\"mt-2 text-xs bg-[#eeeeee] px-2 py-1 rounded-lg cursor-pointer\"}],[\"$\",\"div\",null,{\"children\":\"결제연동\",\"style\":{},\"className\":\"mt-2 text-xs bg-[#eeeeee] px-2 py-1 rounded-lg cursor-pointer\"}],[\"$\",\"div\",null,{\"children\":\"PG사\",\"style\":{},\"className\":\"mt-2 text-xs bg-[#eeeeee] px-2 py-1 rounded-lg cursor-pointer\"}],[\"$\",\"div\",null,{\"children\":\"보안\",\"style\":{},\"className\":\"mt-2 text-xs bg-[#eeeeee] px-2 py-1 rounded-lg cursor-pointer\"}]],\"style\":{},\"className\":\"flex space-x-3 h-auto\"}]],\"style\":{},\"className\":\"py-16 space-y-4 border-b-2\"}]],\"style\":{},\"className\":\"pb-20\"}],[[\"$\",\"h2\",null,{\"children\":[\"$\",\"a\",null,{\"href\":\"#TossPayments\",\"children\":\"TossPayments\"}],\"style\":{},\"className\":\"text-2xl font-bold mt-0 mb-9 after:content-['.'] after:text-red-500 cursor-pointer\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[[\"$\",\"a\",null,{\"target\":\"_blank\",\"href\":\"https://namu.wiki/w/%EA%B2%B0%EC%A0%9C%EB%8C%80%ED%96%89%EC%82%AC\",\"children\":\"전자결제대행사\",\"style\":{},\"className\":\"text-lg font-bold text-red-500\"}],\"\\r\\n(PG / Payment Gateway)는 이커머스 결제 지불 대행 서비스를 진행하는 중개업체를 이르는 말인데,\",[\"$\",\"br\",null,{}],\"\\n\",[\"$\",\"strong\",null,{\"children\":\"토스페이먼츠, KG이니시스, NHN KCP\",\"style\":{},\"className\":\"font-bold\"}],\" 이 3개 업체가 가장 높은 점유율을 차지한다.\"],\"style\":{},\"className\":\"text-lg py-3\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"나는 가장 점유율이 높고, 개발자센터를 통해 쉽고 간편하게 연동할 수 있는 토스페이먼츠를 사용해보기로 했다.\",\"style\":{},\"className\":\"text-lg py-3\"}],\"\\n\",[\"$\",\"hr\",null,{\"children\":\"$undefined\",\"style\":{},\"className\":\"my-20 w-full h-[2px] bg-t-main\"}],\"\\n\",[\"$\",\"h2\",null,{\"children\":[\"$\",\"a\",null,{\"href\":\"#결제 프로세스와 검증\",\"children\":\"결제 프로세스와 검증\"}],\"style\":{},\"className\":\"text-2xl font-bold mt-0 mb-9 after:content-['.'] after:text-red-500 cursor-pointer\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[[\"$\",\"div\",null,{\"children\":[[\"$\",\"img\",null,{\"src\":\"/posts/deep/tossPayments/toss_payments.png\",\"children\":\"$undefined\",\"style\":{},\"className\":\"mx-auto\"}],[\"$\",\"p\",null,{\"children\":\"토스페이먼츠 결제 과정\",\"style\":{},\"className\":\"text-xs text-gray-400\"}]],\"style\":{},\"className\":\"w-full mx-auto py-6 text-center\"}],\"\\r\\n토스페이먼츠(*이하토스)의 결제 과정은 다음과같다.\"],\"style\":{},\"className\":\"text-lg py-3\"}],\"\\n\",[\"$\",\"ol\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":\"토스페이먼츠에서 제공하는 결제위젯을 화면에 전시\",\"style\":{},\"className\":\"pl-6 py-2 text-lg before:content-['-'] before:font-bold before:pr-3\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"결제하기로 요청\",\"style\":{},\"className\":\"pl-6 py-2 text-lg before:content-['-'] before:font-bold before:pr-3\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"사용자 결제\",\"style\":{},\"className\":\"pl-6 py-2 text-lg before:content-['-'] before:font-bold before:pr-3\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"결제승인 API요청\",\"style\":{},\"className\":\"pl-6 py-2 text-lg before:content-['-'] before:font-bold before:pr-3\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"성공, 실패 Url로 리다이렉트\",\"style\":{},\"className\":\"pl-6 py-2 text-lg before:content-['-'] before:font-bold before:pr-3\"}],\"\\n\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"이 일련의 과정속에서 가장 중요한건 MITM을 막고 데이터의 무결성을 훼손하지 않는일일 것이다.\",\"style\":{},\"className\":\"text-lg py-3\"}],\"\\n\",[\"$\",\"hr\",null,{\"children\":\"$undefined\",\"style\":{},\"className\":\"my-20 w-full h-[2px] bg-t-main\"}],\"\\n\",[\"$\",\"h2\",null,{\"children\":[\"$\",\"a\",null,{\"href\":\"#접근 방법\",\"children\":\"접근 방법\"}],\"style\":{},\"className\":\"text-2xl font-bold mt-0 mb-9 after:content-['.'] after:text-red-500 cursor-pointer\"}],\"\\n\",[\"$\",\"h3\",null,{\"children\":\"1\",\"style\":{},\"className\":\"text-xl font-bold mt-9 mb-6\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"1번에서 백엔드로 결제ID와 금액, 몇가지 구매정보를 보내 DB와 비교후 저장한다. 이를 통해 1차 가격변조를 막고 주문가능 상태를 한번 더 확인한다.\",\"style\":{},\"className\":\"text-lg py-3\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"[토스페이먼츠에서 제공하는 결제창 진입 직전에 백엔드와의 통신이 일어나지만, JWT만 있다면 포스트맨으로도 접근이 가능하다.]\",\"style\":{},\"className\":\"text-lg py-3\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"[결제ID를 현재시간 + 금액등을 조합해 Hash하여 백엔드로 보내 다시 검증한다면 포스트맨 등의 엔드포인트 접근을 막을 수 있을 것 같다.]\",\"style\":{},\"className\":\"text-lg py-3\"}],\"\\n\",[\"$\",\"h3\",null,{\"children\":\"2-1\",\"style\":{},\"className\":\"text-xl font-bold mt-9 mb-6\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"1번에서 추가로 결제창 진입과 동시에 기존의 상품 갯수를 줄여놓고 페이지이탈(새로고침, 브라우저 닫기, 결제창 닫기 등)시\\r\\nbeforeunload과 sendBeacon을 통해 상품의 갯수를 롤백 하는 방식을 택하려 했으나, 브라우저 호환성이나 결제가 완료되고 리다이렉트 되는 경우에도 롤백하는 경우가 생긴다.\",\"style\":{},\"className\":\"text-lg py-3\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"[롤백이 될때 추가로 백엔드와 통신하게 되는데 만약 포스트맨으로 이 롤백을 실행한다면, 상품갯수를 줄이고 주문을 추가로 넣을 수 있다.]\",\"style\":{},\"className\":\"text-lg py-3\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"[1번과 동일하게 Hash하여 백엔드로 보내 1번에서 저장한 데이터와 비교한다고해도 DB원본에 대한 접근횟수가 너무 많아진다.]\",\"style\":{},\"className\":\"text-lg py-3\"}],\"\\n\",[\"$\",\"h3\",null,{\"children\":\"2-2\",\"style\":{},\"className\":\"text-xl font-bold mt-9 mb-6\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"2-1과 같은 문제를 해결하기 위해 롤백을 실행하는 일을 백엔드 자체에 맡길 수 있다. 1번에서 저장한 데이터에 status를 추가하여,\\r\\n결제가 완료를 판단 백엔드에서 1분간격으로 롤백을 진행하여 DB에 반영한다.\",\"style\":{},\"className\":\"text-lg py-3\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"[실시간성은 하락하고 백엔드의 부하는 늘어난다. 또 사실상 DB접근 빈도가 2-1보다 많을 가능성도 있다.]\",\"style\":{},\"className\":\"text-lg py-3\"}],\"\\n\",[\"$\",\"h3\",null,{\"children\":\"2-3\",\"style\":{},\"className\":\"text-xl font-bold mt-9 mb-6\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"가장 좋은 방법은 백엔드에게 결제를 맡기는 일이다. successUrl을 직접 백엔드 엔드포인트로 연결,\\r\\n구매정보비교 -\u003e 주문가능 상태 확인 -\u003e 상품 갯수 줄이기 -\u003e 결제 -\u003e 성공 / 실패시 롤백의 순으로 진행하면 된다.\\r\\nDB접근 횟수도 줄어들고, 실시간성도 보장된다.\",\"style\":{},\"className\":\"text-lg py-3\"}],\"\\n\",[\"$\",\"hr\",null,{\"children\":\"$undefined\",\"style\":{},\"className\":\"my-20 w-full h-[2px] bg-t-main\"}],\"\\n\",[\"$\",\"h2\",null,{\"children\":[\"$\",\"a\",null,{\"href\":\"#최종 설계 모델\",\"children\":\"최종 설계 모델\"}],\"style\":{},\"className\":\"text-2xl font-bold mt-0 mb-9 after:content-['.'] after:text-red-500 cursor-pointer\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"$\",\"div\",null,{\"children\":[[\"$\",\"img\",null,{\"src\":\"/posts/deep/tossPayments/toss_payments_arch.png\",\"children\":\"$undefined\",\"style\":{},\"className\":\"mx-auto\"}],[\"$\",\"p\",null,{\"children\":\"토스페이먼츠 설계\",\"style\":{},\"className\":\"text-xs text-gray-400\"}]],\"style\":{},\"className\":\"w-full mx-auto py-6 text-center\"}],\"style\":{},\"className\":\"text-lg py-3\"}],\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":\"2-3은 successUrl을 받고 결제 승인 API를 보내기 전에 서버에서 처리된다.\",\"style\":{},\"className\":\"pl-6 py-2 text-lg before:content-['-'] before:font-bold before:pr-3\"}],\"\\n\"]}]]]\n"])</script><script>self.__next_f.push([1,"c:[[\"$\",\"meta\",\"0\",{\"name\":\"viewport\",\"content\":\"width=device-width, initial-scale=1\"}],[\"$\",\"meta\",\"1\",{\"charSet\":\"utf-8\"}],[\"$\",\"title\",\"2\",{\"children\":\"TossPayments의 대한 깊은 고찰\"}],[\"$\",\"meta\",\"3\",{\"name\":\"description\",\"content\":\"결제는 몇번의 검증이 들어가야 좋을까?\"}],[\"$\",\"link\",\"4\",{\"rel\":\"canonical\",\"href\":\"https://weaall.github.io/\"}],[\"$\",\"meta\",\"5\",{\"property\":\"og:title\",\"content\":\"Weaall's Dive\"}],[\"$\",\"meta\",\"6\",{\"property\":\"og:description\",\"content\":\"Weaall's pretty personal idea\"}],[\"$\",\"meta\",\"7\",{\"property\":\"og:url\",\"content\":\"https://weaall.github.io/\"}],[\"$\",\"meta\",\"8\",{\"property\":\"og:site_name\",\"content\":\"Weaall's Dive\"}],[\"$\",\"meta\",\"9\",{\"property\":\"og:image\",\"content\":\"https://weaall.github.io/profile.png\"}],[\"$\",\"meta\",\"10\",{\"property\":\"og:image:alt\",\"content\":\"Weaall's Dive\"}],[\"$\",\"meta\",\"11\",{\"property\":\"og:type\",\"content\":\"website\"}],[\"$\",\"meta\",\"12\",{\"name\":\"twitter:card\",\"content\":\"summary_large_image\"}],[\"$\",\"meta\",\"13\",{\"name\":\"twitter:title\",\"content\":\"Weaall's Dive\"}],[\"$\",\"meta\",\"14\",{\"name\":\"twitter:description\",\"content\":\"Weaall's pretty personal idea\"}],[\"$\",\"meta\",\"15\",{\"name\":\"twitter:image\",\"content\":\"https://weaall.github.io/profile.png\"}],[\"$\",\"meta\",\"16\",{\"name\":\"twitter:image:alt\",\"content\":\"Weaall's Dive\"}]]\n"])</script><script>self.__next_f.push([1,"5:null\n"])</script><script>self.__next_f.push([1,""])</script></body></html>