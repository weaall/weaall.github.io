3:I[5613,[],""]
5:I[1778,[],""]
6:I[7709,["229","static/chunks/229-125a0445ef9a59b1.js","250","static/chunks/250-e1cebaeae1771402.js","185","static/chunks/app/layout-1635e8ee7b1540f1.js"],""]
7:I[8667,["160","static/chunks/app/not-found-817c2752032c2711.js"],""]
8:I[8036,["229","static/chunks/229-125a0445ef9a59b1.js","250","static/chunks/250-e1cebaeae1771402.js","185","static/chunks/app/layout-1635e8ee7b1540f1.js"],""]
4:["slug","deep-gp3-iops-setting","d"]
0:["NBONtNsrghgEhSVvdns2t",[[["",{"children":["(pages)",{"children":["deep",{"children":[["slug","deep-gp3-iops-setting","d"],{"children":["__PAGE__?{\"slug\":\"deep-gp3-iops-setting\"}",{}]}]}]}]},"$undefined","$undefined",true],["",{"children":["(pages)",{"children":["deep",{"children":[["slug","deep-gp3-iops-setting","d"],{"children":["__PAGE__",{},["$L1","$L2",null]]},["$","$L3",null,{"parallelRouterKey":"children","segmentPath":["children","(pages)","children","deep","children","$4","children"],"loading":"$undefined","loadingStyles":"$undefined","loadingScripts":"$undefined","hasLoading":false,"error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L5",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":"$undefined","notFoundStyles":"$undefined","styles":null}]]},["$","$L3",null,{"parallelRouterKey":"children","segmentPath":["children","(pages)","children","deep","children"],"loading":"$undefined","loadingStyles":"$undefined","loadingScripts":"$undefined","hasLoading":false,"error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L5",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":"$undefined","notFoundStyles":"$undefined","styles":null}]]},["$","$L3",null,{"parallelRouterKey":"children","segmentPath":["children","(pages)","children"],"loading":"$undefined","loadingStyles":"$undefined","loadingScripts":"$undefined","hasLoading":false,"error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L5",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":"$undefined","notFoundStyles":"$undefined","styles":null}]]},[null,["$","html",null,{"lang":"kr","children":[["$","head",null,{"children":[["$","meta",null,{"name":"naver-site-verification","content":"e782934088f4524e1d46947402328d9864f04318"}],["$","meta",null,{"name":"google-site-verification","content":"EB5qLPhkvA7mD6Yz6VpiZaMErWP4KIB7Aj_rR-xqdsA"}],["$","link",null,{"rel":"icon","href":"/favicon.ico"}]]}],["$","body",null,{"className":"__className_a1b02f","children":["$","div",null,{"children":["$","div",null,{"children":[["$","$L6",null,{}],["$","$L3",null,{"parallelRouterKey":"children","segmentPath":["children"],"loading":"$undefined","loadingStyles":"$undefined","loadingScripts":"$undefined","hasLoading":false,"error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L5",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":["$","$L7",null,{}],"notFoundStyles":[],"styles":null}],["$","$L8",null,{}]],"style":{},"className":"mx-auto max-w-[1080px] h-auto px-1"}],"style":{},"className":"mx-auto text-main"}]}]]}],null]],[[["$","link","0",{"rel":"stylesheet","href":"/_next/static/css/6a5f3c35560f6327.css","precedence":"next","crossOrigin":""}],["$","link","1",{"rel":"stylesheet","href":"/_next/static/css/4837ad08e76e29b1.css","precedence":"next","crossOrigin":""}],["$","link","2",{"rel":"stylesheet","href":"/_next/static/css/e70dff98502bd6db.css","precedence":"next","crossOrigin":""}]],"$L9"]]]]
a:I[9275,["229","static/chunks/229-125a0445ef9a59b1.js","624","static/chunks/624-671fa786836002d7.js","606","static/chunks/app/(pages)/deep/%5Bslug%5D/page-0f8f53d5c22a66de.js"],"MDXContent"]
b:I[2946,["229","static/chunks/229-125a0445ef9a59b1.js","624","static/chunks/624-671fa786836002d7.js","606","static/chunks/app/(pages)/deep/%5Bslug%5D/page-0f8f53d5c22a66de.js"],"H2"]
c:I[2946,["229","static/chunks/229-125a0445ef9a59b1.js","624","static/chunks/624-671fa786836002d7.js","606","static/chunks/app/(pages)/deep/%5Bslug%5D/page-0f8f53d5c22a66de.js"],"Li"]
d:I[2946,["229","static/chunks/229-125a0445ef9a59b1.js","624","static/chunks/624-671fa786836002d7.js","606","static/chunks/app/(pages)/deep/%5Bslug%5D/page-0f8f53d5c22a66de.js"],"Img"]
e:I[2946,["229","static/chunks/229-125a0445ef9a59b1.js","624","static/chunks/624-671fa786836002d7.js","606","static/chunks/app/(pages)/deep/%5Bslug%5D/page-0f8f53d5c22a66de.js"],"H3"]
f:I[2946,["229","static/chunks/229-125a0445ef9a59b1.js","624","static/chunks/624-671fa786836002d7.js","606","static/chunks/app/(pages)/deep/%5Bslug%5D/page-0f8f53d5c22a66de.js"],"Em"]
10:I[2946,["229","static/chunks/229-125a0445ef9a59b1.js","624","static/chunks/624-671fa786836002d7.js","606","static/chunks/app/(pages)/deep/%5Bslug%5D/page-0f8f53d5c22a66de.js"],"Pre"]
11:I[2946,["229","static/chunks/229-125a0445ef9a59b1.js","624","static/chunks/624-671fa786836002d7.js","606","static/chunks/app/(pages)/deep/%5Bslug%5D/page-0f8f53d5c22a66de.js"],"Code"]
12:Te1f,import boto3
import os
from datetime import datetime, timedelta

def lambda_handler(event, context):
    db_instance_identifier = os.environ['DB_INSTANCE_IDENTIFIER']  # 환경 변수에서 RDS 인스턴스 ID 가져오기
    cloudwatch = boto3.client('cloudwatch')
    
    # 지난 5분의 평균 IOPS와 쓰루풋 조회
    average_iops = get_average_iops(db_instance_identifier, cloudwatch)
    average_throughput = get_average_throughput(db_instance_identifier, cloudwatch)

    # 새로운 IOPS와 쓰루풋 계산
    new_iops = max(int(average_iops * 1.15), 3000)  # 15% 증가 및 최소 IOPS 3000
    new_throughput = max(int(average_throughput * 1.15), 125)  # 15% 증가, 최소 125 MiB/s 제한

    # 결과 반환
    return {
        'statusCode': 200,
        'body': f'Calculated IOPS: {new_iops}, Calculated Throughput: {new_throughput} MiB/s'
    }

def get_average_iops(db_instance_identifier, cloudwatch):
    end_time = datetime.utcnow()
    start_time = end_time - timedelta(minutes=5)
    
    # 읽기와 쓰기 IOPS 메트릭을 가져옴
    read_response = cloudwatch.get_metric_statistics(
        Namespace='AWS/RDS',
        MetricName='ReadIOPS',
        StartTime=start_time,
        EndTime=end_time,
        Period=60,
        Statistics=['Average'],
        Dimensions=[{'Name': 'DBInstanceIdentifier', 'Value': db_instance_identifier}]
    )
    
    write_response = cloudwatch.get_metric_statistics(
        Namespace='AWS/RDS',
        MetricName='WriteIOPS',
        StartTime=start_time,
        EndTime=end_time,
        Period=60,
        Statistics=['Average'],
        Dimensions=[{'Name': 'DBInstanceIdentifier', 'Value': db_instance_identifier}]
    )
    
    # 읽기와 쓰기 IOPS 평균을 더함
    read_iops = sum(dp['Average'] for dp in read_response['Datapoints']) / len(read_response['Datapoints']) if read_response['Datapoints'] else 0
    write_iops = sum(dp['Average'] for dp in write_response['Datapoints']) / len(write_response['Datapoints']) if write_response['Datapoints'] else 0

    average_iops = read_iops + write_iops  # 읽기와 쓰기 IOPS 합산
    return average_iops

def get_average_throughput(db_instance_identifier, cloudwatch):
    end_time = datetime.utcnow()
    start_time = end_time - timedelta(minutes=5)
    
    # ReadThroughput과 WriteThroughput 메트릭을 가져옴
    read_response = cloudwatch.get_metric_statistics(
        Namespace='AWS/RDS',
        MetricName='ReadThroughput',
        StartTime=start_time,
        EndTime=end_time,
        Period=60,
        Statistics=['Average'],
        Dimensions=[{'Name': 'DBInstanceIdentifier', 'Value': db_instance_identifier}]
    )
    
    write_response = cloudwatch.get_metric_statistics(
        Namespace='AWS/RDS',
        MetricName='WriteThroughput',
        StartTime=start_time,
        EndTime=end_time,
        Period=60,
        Statistics=['Average'],
        Dimensions=[{'Name': 'DBInstanceIdentifier', 'Value': db_instance_identifier}]
    )
    
    # 읽기와 쓰기 바이트 평균을 더해 Throughput을 MiB 단위로 변환
    read_bytes = sum(dp['Average'] for dp in read_response['Datapoints']) / len(read_response['Datapoints']) if read_response['Datapoints'] else 0
    write_bytes = sum(dp['Average'] for dp in write_response['Datapoints']) / len(write_response['Datapoints']) if write_response['Datapoints'] else 0

    average_throughput_mib = (read_bytes + write_bytes) / (1024 * 1024)  # MiB 단위로 변환
    return average_throughput_mib

2:["$","$La",null,{"content":[["$","$Lb",null,{"children":"Auto buffer"}],"\n",["$","p",null,{"children":"AWS GP3 RDS를 사용할 때 IOPS와 Throughput은 스토리지 저장 비용을 제외하고도 추가적인 비용을 필요로 한다.\r\nRedis 캐싱은 최소 60%, 최대 90%까지 IOPS와 Throughput 접근을 줄여서,\r\nIOPS와 Throughput 비용 감소와 RDS 인스턴스 비용 감소에도 도움이 되지만,\r\n사용자 트래픽은 시간대별로 다르므로 실시간 관리 및 자동화 또한 비용절감에 크게 도움이된다.\r\nCloudWatch와 EventBridge, Lambda를 통해 비용 효율적으로 관리해보자."}],"\n",["$","br",null,{}],"\n",["$","ul",null,{"children":["\n",["$","$Lc",null,{"children":"CloudWatch : 기본매트릭 사용 (무료)"}],"\n",["$","$Lc",null,{"children":"Lambda : 월 8640건 이벤트 (월 100만건 무료)"}],"\n",["$","$Lc",null,{"children":"EventBridgeSchedule : 월 8640건 이벤트 (월 100만건 무료)"}],"\n"]}],"\n",["$","p",null,{"children":["$","$Ld",null,{"src":"/posts/deep/gp3-iops-setting/arch.png","alt":"1","title":"아키텍쳐"}]}],"\n",["$","br",null,{}],"\n",["$","$Le",null,{"children":"AWS Lambda 함수 생성"}],"\n",["$","ul",null,{"children":["\n",["$","$Lc",null,{"children":"AWS Lambda 콘솔에 접속, 함수생성"}],"\n",["$","$Lc",null,{"children":"함수이름을 입력하고, 런타임으로 Python 3.x을 선택 후 함수 생성"}],"\n"]}],"\n",["$","br",null,{}],"\n",["$","$Le",null,{"children":"IAM 역할 설정"}],"\n",["$","ul",null,{"children":["\n",["$","$Lc",null,{"children":["구성 -> 권한 -> 역할이름 ",["$","$Lf",null,{"children":"함수이름-role"}],"클릭"]}],"\n",["$","$Lc",null,{"children":["권한추가 -> 권한연결 -> ",["$","$Lf",null,{"children":"CloudWatchReadOnlyAccess"}]," -> 권한추가"]}],"\n"]}],"\n",["$","br",null,{}],"\n",["$","$Le",null,{"children":"환경변수 설정"}],"\n",["$","ul",null,{"children":["\n",["$","$Lc",null,{"children":"구성 -> 환경변수 -> 편집"}],"\n",["$","$Lc",null,{"children":[["$","$Lf",null,{"children":"DB_INSTANCE_IDENTIFIER"}],"를 키, RDS 인스턴스의 DB 식별자를 값으로 입력"]}],"\n"]}],"\n",["$","br",null,{}],"\n",["$","$Le",null,{"children":"코드배포"}],"\n",["$","$L10",null,{"children":["$","$L11",null,{"className":"language-python","children":"$12"}]}],"\n",["$","br",null,{}],"\n",["$","$Le",null,{"children":"테스트"}],"\n",["$","ul",null,{"children":["\n",["$","$Lc",null,{"children":"테스트 -> 기본 템플릿 -> 테스트 -> 로그확인"}],"\n"]}],"\n",["$","$L10",null,{"children":["$","$L11",null,{"className":"language-json","children":"{\r\n  \"statusCode\": 200,\r\n  \"body\": \"Calculated IOPS: 3000, Calculated Throughput: 125 MiB/s\"\r\n}\n"}]}],"\n",["$","br",null,{}],"\n",["$","$Le",null,{"children":"Amazon EventBridge"}],"\n",["$","ul",null,{"children":["\n",["$","$Lc",null,{"children":"규칙 -> 규칙생성 -> 일정 -> 이벤트브릿지 스캐줄러에서 계속"}],"\n",["$","$Lc",null,{"children":["일정패턴 -> 반복일정 -> Rate 기반 일정 -> ",["$","$Lf",null,{"children":"rate(5 minutes)"}]]}],"\n",["$","$Lc",null,{"children":"AWS Lambda -> Lambda 함수 선택"}],"\n"]}]],"frontmatter":{"label":"AWS","title":"람다(Lambda)를 이용한 AWS GP3 RDS 버퍼 자동화 (IOPS, Throughput)","subTitle":"io2 Block Express보다 GP3의 비용을 줄일 수 있을까?","date":"2024.10.01","mins":20,"tags":["AWS","GP3","EBS","RDS","Lambda","IOPS","Throughput","CloudWatch","EventBridge"],"imageUrl":"/posts/deep/gp3-iops-setting/arch.png"}}]
9:[["$","meta","0",{"name":"viewport","content":"width=device-width, initial-scale=1"}],["$","meta","1",{"charSet":"utf-8"}],["$","title","2",{"children":"람다(Lambda)를 이용한 AWS GP3 RDS 버퍼 자동화 (IOPS, Throughput)"}],["$","meta","3",{"name":"description","content":"io2 Block Express보다 GP3의 비용을 줄일 수 있을까?"}],["$","link","4",{"rel":"canonical","href":"https://weaall.github.io/"}],["$","meta","5",{"property":"og:title","content":"Weaall's Dive"}],["$","meta","6",{"property":"og:description","content":"Weaall's pretty personal idea"}],["$","meta","7",{"property":"og:url","content":"https://weaall.github.io/"}],["$","meta","8",{"property":"og:site_name","content":"Weaall's Dive"}],["$","meta","9",{"property":"og:locale","content":"ko_KR"}],["$","meta","10",{"property":"og:image","content":"https://weaall.github.io/profile.png"}],["$","meta","11",{"property":"og:image:alt","content":"Weaall's Dive"}],["$","meta","12",{"property":"og:image","content":"https://weaall.github.io/another-image.jpg"}],["$","meta","13",{"property":"og:image:alt","content":"보조 이미지 설명"}],["$","meta","14",{"property":"og:type","content":"website"}],["$","meta","15",{"name":"twitter:card","content":"summary_large_image"}],["$","meta","16",{"name":"twitter:title","content":"Weaall's Dive"}],["$","meta","17",{"name":"twitter:description","content":"Weaall's pretty personal idea"}],["$","meta","18",{"name":"twitter:image","content":"https://weaall.github.io/profile.png"}],["$","meta","19",{"name":"twitter:image:alt","content":"Weaall's Dive"}],["$","meta","20",{"name":"twitter:image","content":"https://weaall.github.io/another-image.jpg"}],["$","meta","21",{"name":"twitter:image:alt","content":"보조 이미지 설명"}],["$","link","22",{"rel":"icon","href":"/favicon.ico","type":"image/x-icon","sizes":"16x16"}]]
1:null
