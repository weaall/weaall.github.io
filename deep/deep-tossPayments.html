<!DOCTYPE html><html lang="kr"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="preload" as="image" href="../../assets/svg/search_icon.svg"/><link rel="preload" as="image" href="../../assets/svg/user_icon.svg"/><link rel="preload" as="image" href="../..//posts/deep/tossPayments/TossPayments_Logo_Primary_Reverse.png"/><link rel="preload" as="image" href="../../assets/svg/calendar_icon.svg"/><link rel="preload" as="image" href="../../assets/svg/book_icon.svg"/><link rel="stylesheet" href="/_next/static/css/6a5f3c35560f6327.css" crossorigin="" data-precedence="next"/><link rel="stylesheet" href="/_next/static/css/86a6d0ddcdf4d536.css" crossorigin="" data-precedence="next"/><link rel="preload" as="script" fetchPriority="low" href="/_next/static/chunks/webpack-95e5bfa470cf0f4f.js" crossorigin=""/><script src="/_next/static/chunks/fd9d1056-9f4872b31ac6bec8.js" async="" crossorigin=""></script><script src="/_next/static/chunks/938-b76dc1bec181dd03.js" async="" crossorigin=""></script><script src="/_next/static/chunks/main-app-7faaf895136a49f7.js" async="" crossorigin=""></script><script src="/_next/static/chunks/229-125a0445ef9a59b1.js" async=""></script><script src="/_next/static/chunks/396-5caf943e3aaa48dc.js" async=""></script><script src="/_next/static/chunks/app/layout-6e46387ac1d9bd8a.js" async=""></script><script src="/_next/static/chunks/app/not-found-817c2752032c2711.js" async=""></script><script src="/_next/static/chunks/624-820220bab49ef968.js" async=""></script><script src="/_next/static/chunks/app/(pages)/deep/%5Bslug%5D/page-0f8f53d5c22a66de.js" async=""></script><meta name="naver-site-verification" content="e782934088f4524e1d46947402328d9864f04318"/><meta name="google-site-verification" content="EB5qLPhkvA7mD6Yz6VpiZaMErWP4KIB7Aj_rR-xqdsA"/><link rel="icon" href="/favicon.ico"/><title>TossPayments의 대한 깊은 고찰</title><meta name="description" content="결제는 몇번의 검증이 들어가야 좋을까?"/><link rel="canonical" href="https://weaall.github.io/"/><meta property="og:title" content="Weaall&#x27;s Dive"/><meta property="og:description" content="Weaall&#x27;s pretty personal idea"/><meta property="og:url" content="https://weaall.github.io/"/><meta property="og:site_name" content="Weaall&#x27;s Dive"/><meta property="og:locale" content="ko_KR"/><meta property="og:image" content="https://weaall.github.io/profile.png"/><meta property="og:image:alt" content="Weaall&#x27;s Dive"/><meta property="og:image" content="https://weaall.github.io/another-image.jpg"/><meta property="og:image:alt" content="보조 이미지 설명"/><meta property="og:type" content="website"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:title" content="Weaall&#x27;s Dive"/><meta name="twitter:description" content="Weaall&#x27;s pretty personal idea"/><meta name="twitter:image" content="https://weaall.github.io/profile.png"/><meta name="twitter:image:alt" content="Weaall&#x27;s Dive"/><meta name="twitter:image" content="https://weaall.github.io/another-image.jpg"/><meta name="twitter:image:alt" content="보조 이미지 설명"/><link rel="icon" href="/favicon.ico" type="image/x-icon" sizes="16x16"/><script src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js" crossorigin="" noModule=""></script></head><body class="__className_a1b02f"><div class="mx-auto text-main max-w-[1080px]"><div class="mx-auto max-w-[1080px] h-auto px-1"><div class="max-w-[1080px] w-full flex items-center justify-between mt-4 bg-t-main px-8 py-10 font-medium mobile:mt-0 mobile:rounded-none rounded-[60px] mb-4 mobile:mb-2 mobile:rounded-b-[30px]"><nav class="flex w-auto justify-between items-center"><button class="bg-white rounded-full mr-2"><img alt="" src="../../assets/svg/search_icon.svg" class="min-w-7 min-h-7 p-0.5 m-auto hover:scale-105"/></button><nav class="w-auto items-center flex space-x-2"><div class="text-main text-xs bg-white rounded-full px-2 py-1.5 items-center"><a class="hover:after:text-red-500 after:content-[&#x27;.&#x27;] after:text-transparent" href="/shallow">SHALLOW</a></div><div class="text-main text-xs bg-white rounded-full px-2 py-1.5 items-center"><a class="hover:after:text-red-500 after:content-[&#x27;.&#x27;] after:text-transparent" href="/deep">DEEP</a></div><div class="text-main text-xs bg-white rounded-full px-2 py-1.5 items-center"><a class="hover:after:text-red-500 after:content-[&#x27;.&#x27;] after:text-transparent" href="/prac">PRAC</a></div></nav></nav><div class="flex"><button class="text-main text-xs group"><a href="/"><p class="px-0.5 group-hover:scale-105 hover:after:text-red-500 after:content-[&#x27;.&#x27;] after:text-transparent">home</p></a></button><p class="px-0.5 group-hover:scale-105 hover:after:text-red-500 after:content-[&#x27;.&#x27;] after:text-transparent">/</p><button class="text-main text-xs group"><a href="/me"><p class="px-0.5 group-hover:scale-105 hover:after:text-red-500 after:content-[&#x27;.&#x27;] after:text-transparent">me</p></a></button><p class="px-0.5 group-hover:scale-105 hover:after:text-red-500 after:content-[&#x27;.&#x27;] after:text-transparent">/</p><button class="text-main text-xs group"><a href="https://github.com/weaall" target="_blank" rel="noopener noreferrer"><p class="px-0.5 group-hover:scale-105 hover:after:text-red-500 after:content-[&#x27;.&#x27;] after:text-transparent">github</p></a></button><p class="px-0.5 group-hover:scale-105 hover:after:text-red-500 after:content-[&#x27;.&#x27;] after:text-transparent">/</p><button class="text-main text-xs group"><a href="/dev/intro"><p class="px-0.5 group-hover:scale-105 hover:after:text-red-500 after:content-[&#x27;.&#x27;] after:text-transparent">dev</p></a></button></div></div><div class="w-full flex space-x-6 px-10 mobile:px-6"><div class="w-full"><div class="pb-12"><div class="w-full bg-main h-96 rounded-xl mobile:h-60 content-center flex justify-center p-6"><img alt="" src="../..//posts/deep/tossPayments/TossPayments_Logo_Primary_Reverse.png" class="rounded-xl h-full w-full object-contain"/></div><div class="py-8 space-y-3 border-b-2"><h1 class="text-2xl text-main font-bold after:content-[&#x27;.&#x27;] after:text-red-500">TossPayments의 대한 깊은 고찰</h1><p class="text-base">결제는 몇번의 검증이 들어가야 좋을까?</p><div class="flex h-auto"><img alt="" src="../../assets/svg/calendar_icon.svg" class="w-4 mr-3"/><p class="text-sm text-main mr-10">2024.06.06</p><img alt="" src="../../assets/svg/book_icon.svg" class="w-4 mr-3"/><p class="text-sm text-main mr-10">20<!-- -->mins</p></div><div class="flex space-x-3 h-auto"><div class="mt-2 text-xs bg-t-main px-2 py-1 rounded-lg cursor-pointer">Toss</div><div class="mt-2 text-xs bg-t-main px-2 py-1 rounded-lg cursor-pointer">TossPayments</div><div class="mt-2 text-xs bg-t-main px-2 py-1 rounded-lg cursor-pointer">결제연동</div><div class="mt-2 text-xs bg-t-main px-2 py-1 rounded-lg cursor-pointer">PG사</div><div class="mt-2 text-xs bg-t-main px-2 py-1 rounded-lg cursor-pointer">보안</div></div></div></div><h2 class="text-xl font-bold mt-2 mb-4 after:content-[&#x27;.&#x27;] after:text-red-500 cursor-pointer">TossPayments</h2>
<p><a target="_blank" href="https://namu.wiki/w/%EA%B2%B0%EC%A0%9C%EB%8C%80%ED%96%89%EC%82%AC" class="text-base font-bold text-red-500">전자결제대행사</a>
(PG / Payment Gateway)는 이커머스 결제 지불 대행 서비스를 진행하는 중개업체를 이르는 말인데,
<strong class="font-bold">토스페이먼츠, KG이니시스, NHN KCP</strong> 이 3개 업체가 가장 높은 점유율을 차지한다.</p>
<p>나는 가장 점유율이 높고, 개발자센터를 통해 쉽고 간편하게 연동할 수 있는 토스페이먼츠를 사용해보기로 했다.</p>
<hr class="my-10 w-full h-[2px] bg-t-main"/>
<h2 class="text-xl font-bold mt-2 mb-4 after:content-[&#x27;.&#x27;] after:text-red-500 cursor-pointer">결제 프로세스와 검증</h2>
<p><span class="w-full mx-auto py-6 text-center flex flex-col"><img src="/posts/deep/tossPayments/toss_payments.png" loading="lazy" class="mx-auto"/><span class="w-full text-center text-xs text-gray-400">토스페이먼츠 결제 과정</span></span>
<strong class="font-bold">토스페이먼츠</strong>(*이하토스)의 결제 과정은 다음과같다.</p>
<br/>
<ol>
<li class="pl-6 py-1 text-base before:content-[&#x27;-&#x27;] before:font-bold before:pr-3">토스페이먼츠에서 제공하는 결제위젯을 화면에 전시</li>
<li class="pl-6 py-1 text-base before:content-[&#x27;-&#x27;] before:font-bold before:pr-3">결제하기로 요청</li>
<li class="pl-6 py-1 text-base before:content-[&#x27;-&#x27;] before:font-bold before:pr-3">사용자 결제</li>
<li class="pl-6 py-1 text-base before:content-[&#x27;-&#x27;] before:font-bold before:pr-3">결제승인 API요청</li>
<li class="pl-6 py-1 text-base before:content-[&#x27;-&#x27;] before:font-bold before:pr-3">성공, 실패 Url로 리다이렉트</li>
</ol>
<br/>
<p>이 일련의 과정속에서 가장 중요한건 MITM을 막고 데이터의 무결성을 훼손하지 않는일일 것이다.</p>
<hr class="my-10 w-full h-[2px] bg-t-main"/>
<h2 class="text-xl font-bold mt-2 mb-4 after:content-[&#x27;.&#x27;] after:text-red-500 cursor-pointer">접근 방법</h2>
<h3 class="text-lg font-bold">1번 통신에 대한 접근</h3>
<br/>
<p>1번에서 백엔드로 결제ID와 금액, 몇가지 구매정보를 보내 DB와 비교후 저장한다. 이를 통해 1차 가격변조를 막고 주문가능 상태를 한번 더 확인한다.</p>
<br/>
<p>[토스페이먼츠에서 제공하는 결제창 진입 직전에 백엔드와의 통신이 일어나지만, JWT만 있다면 포스트맨으로도 접근이 가능하다.]</p>
<br/>
<p>[결제ID를 현재시간 + 금액등을 조합해 Hash하여 백엔드로 보내 다시 검증한다면 포스트맨 등의 엔드포인트 접근을 막을 수 있을 것 같다.]</p>
<br/>
<h3 class="text-lg font-bold">2번 통신에 대한 첫번째 접근</h3>
<br/>
<p>1번에서 추가로 결제창 진입과 동시에 기존의 상품 갯수를 줄여놓고 페이지이탈(새로고침, 브라우저 닫기, 결제창 닫기 등)시
beforeunload과 sendBeacon을 통해 상품의 갯수를 롤백 하는 방식을 택하려 했으나, 브라우저 호환성이나 결제가 완료되고 리다이렉트 되는 경우에도 롤백하는 경우가 생긴다.</p>
<br/>
<p>[롤백이 될때 추가로 백엔드와 통신하게 되는데 만약 포스트맨으로 이 롤백을 실행한다면, 상품갯수를 줄이고 주문을 추가로 넣을 수 있다.]</p>
<br/>
<p>[1번과 동일하게 Hash하여 백엔드로 보내 1번에서 저장한 데이터와 비교한다고해도 DB원본에 대한 접근횟수가 너무 많아진다.]</p>
<br/>
<h3 class="text-lg font-bold">2번 통신에 대한 두번째 접근</h3>
<br/>
<p>2-1과 같은 문제를 해결하기 위해 롤백을 실행하는 일을 백엔드 자체에 맡길 수 있다. 1번에서 저장한 데이터에 status를 추가하여,
결제가 완료를 판단 백엔드에서 1분간격으로 롤백을 진행하여 DB에 반영한다.</p>
<br/>
<p>[실시간성은 하락하고 백엔드의 부하는 늘어난다. 또 사실상 DB접근 빈도가 2-1보다 많을 가능성도 있다.]</p>
<br/>
<h3 class="text-lg font-bold">2번 통신에 대한 세번째 접근</h3>
<br/>
<p>가장 좋은 방법은 백엔드에게 결제를 맡기는 일이다. successUrl을 직접 백엔드 엔드포인트로 연결,
구매정보비교 -&gt; 주문가능 상태 확인 -&gt; 상품 갯수 줄이기 -&gt; 결제 -&gt; 성공 / 실패시 롤백의 순으로 진행하면 된다.
DB접근 횟수도 줄어들고, 실시간성도 보장된다.</p>
<br/>
<h3 class="text-lg font-bold">3번 통신에 대한 접근</h3>
<br/>
<p>결제 성공 여부를 토스에서 판단한 후 서버와 통신하기 때문에, 통신 탈취나 데이터 오염 위험이 적다. 다만, 성공 여부의 실시간 보장만이 중요해 보인다.</p>
<br/>
<h3 class="text-lg font-bold">4번 통신에 대한 접근</h3>
<br/>
<p>3번 통신과 동일, 실패 여부의 실시간 보장만이 중요해 보인다.</p>
<hr class="my-10 w-full h-[2px] bg-t-main"/>
<h2 class="text-xl font-bold mt-2 mb-4 after:content-[&#x27;.&#x27;] after:text-red-500 cursor-pointer">최종 설계 모델</h2>
<p><span class="w-full mx-auto py-6 text-center flex flex-col"><img src="/posts/deep/tossPayments/toss_payments_arch.png" loading="lazy" class="mx-auto"/><span class="w-full text-center text-xs text-gray-400">토스페이먼츠 설계</span></span></p>
<p>2-3은 successUrl을 받은 후, 결제 승인 API를 호출하기 전에 서버에서 처리되므로 실시간성과 보안이 어느 정도 보장된다.</p></div><div class="relative w-72 flex flex-col items-end flex-grows mobile:hidden"><div class="sticky top-16 border-l border-gray-200 rounded-none my-4 px-4 text-sm space-y-1"></div></div></div></div><div class="w-full border-t mt-20 text-[#888888] __className_22ceb1"><div class="mx-auto max-w-[1080px] h-40 justify-between flex mobile:flex-col mobile:h-52"><div class="flex flex-col m-auto text-center space-y-1 w-[33%]"><p class="font-bold text-2xl">Dong-Hyun Wi</p><a href="mailto:weaall@naver.com" class="text-sm">weaall@naver.com</a><a href="mailto:weaall88@gmail.com" class="text-sm">weaall88@gmail.com</a></div><div class="flex flex-col m-auto text-center space-y-1 w-[33%]"><a href="/"><img alt="" src="../../assets/svg/user_icon.svg" class="w-8 h-full m-auto group-hover:scale-110"/></a></div><div class="flex m-auto space-x-4 w-[33%] justify-center"><a href="/shallow" class="font-bold text-base">shallow</a><a href="/deep" class="font-bold text-base">deep</a><a href="/me" class="font-bold text-base">me</a><a href="/dev/intro" class="font-bold text-base">dev</a></div></div></div></div><script src="/_next/static/chunks/webpack-95e5bfa470cf0f4f.js" crossorigin="" async=""></script><script>(self.__next_f=self.__next_f||[]).push([0]);self.__next_f.push([2,null])</script><script>self.__next_f.push([1,"1:HL[\"/_next/static/css/6a5f3c35560f6327.css\",\"style\",{\"crossOrigin\":\"\"}]\n2:HL[\"/_next/static/css/86a6d0ddcdf4d536.css\",\"style\",{\"crossOrigin\":\"\"}]\n0:\"$L3\"\n"])</script><script>self.__next_f.push([1,"4:I[7690,[],\"\"]\n7:I[5613,[],\"\"]\n9:I[1778,[],\"\"]\na:I[7709,[\"229\",\"static/chunks/229-125a0445ef9a59b1.js\",\"396\",\"static/chunks/396-5caf943e3aaa48dc.js\",\"185\",\"static/chunks/app/layout-6e46387ac1d9bd8a.js\"],\"\"]\nb:I[8667,[\"160\",\"static/chunks/app/not-found-817c2752032c2711.js\"],\"\"]\nd:I[8955,[],\"\"]\n8:[\"slug\",\"deep-tossPayments\",\"d\"]\n"])</script><script>self.__next_f.push([1,"3:[[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/6a5f3c35560f6327.css\",\"precedence\":\"next\",\"crossOrigin\":\"\"}],[\"$\",\"link\",\"1\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/86a6d0ddcdf4d536.css\",\"precedence\":\"next\",\"crossOrigin\":\"\"}]],[\"$\",\"$L4\",null,{\"buildId\":\"GCWZig9TsapAXJI5a65JT\",\"assetPrefix\":\"\",\"initialCanonicalUrl\":\"/deep/deep-tossPayments\",\"initialTree\":[\"\",{\"children\":[\"(pages)\",{\"children\":[\"deep\",{\"children\":[[\"slug\",\"deep-tossPayments\",\"d\"],{\"children\":[\"__PAGE__?{\\\"slug\\\":\\\"deep-tossPayments\\\"}\",{}]}]}]}]},\"$undefined\",\"$undefined\",true],\"initialSeedData\":[\"\",{\"children\":[\"(pages)\",{\"children\":[\"deep\",{\"children\":[[\"slug\",\"deep-tossPayments\",\"d\"],{\"children\":[\"__PAGE__\",{},[\"$L5\",\"$L6\",null]]},[\"$\",\"$L7\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"(pages)\",\"children\",\"deep\",\"children\",\"$8\",\"children\"],\"loading\":\"$undefined\",\"loadingStyles\":\"$undefined\",\"loadingScripts\":\"$undefined\",\"hasLoading\":false,\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L9\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\",\"styles\":null}]]},[\"$\",\"$L7\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"(pages)\",\"children\",\"deep\",\"children\"],\"loading\":\"$undefined\",\"loadingStyles\":\"$undefined\",\"loadingScripts\":\"$undefined\",\"hasLoading\":false,\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L9\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\",\"styles\":null}]]},[\"$\",\"$L7\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"(pages)\",\"children\"],\"loading\":\"$undefined\",\"loadingStyles\":\"$undefined\",\"loadingScripts\":\"$undefined\",\"hasLoading\":false,\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L9\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\",\"styles\":null}]]},[null,[\"$\",\"html\",null,{\"lang\":\"kr\",\"children\":[[\"$\",\"head\",null,{\"children\":[[\"$\",\"meta\",null,{\"name\":\"naver-site-verification\",\"content\":\"e782934088f4524e1d46947402328d9864f04318\"}],[\"$\",\"meta\",null,{\"name\":\"google-site-verification\",\"content\":\"EB5qLPhkvA7mD6Yz6VpiZaMErWP4KIB7Aj_rR-xqdsA\"}],[\"$\",\"link\",null,{\"rel\":\"icon\",\"href\":\"/favicon.ico\"}]]}],[\"$\",\"body\",null,{\"className\":\"__className_a1b02f\",\"children\":[\"$\",\"div\",null,{\"children\":[[\"$\",\"div\",null,{\"children\":[[\"$\",\"$La\",null,{}],[\"$\",\"$L7\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\"],\"loading\":\"$undefined\",\"loadingStyles\":\"$undefined\",\"loadingScripts\":\"$undefined\",\"hasLoading\":false,\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L9\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":[\"$\",\"$Lb\",null,{}],\"notFoundStyles\":[],\"styles\":null}]],\"style\":{},\"className\":\"mx-auto max-w-[1080px] h-auto px-1\"}],[\"$\",\"div\",null,{\"className\":\"w-full border-t mt-20 text-[#888888] __className_22ceb1\",\"children\":[\"$\",\"div\",null,{\"children\":[[\"$\",\"div\",null,{\"children\":[[\"$\",\"p\",null,{\"children\":\"Dong-Hyun Wi\",\"style\":{},\"className\":\"font-bold text-2xl\"}],[\"$\",\"a\",null,{\"href\":\"mailto:weaall@naver.com\",\"children\":\"weaall@naver.com\",\"style\":{},\"className\":\"text-sm\"}],[\"$\",\"a\",null,{\"href\":\"mailto:weaall88@gmail.com\",\"children\":\"weaall88@gmail.com\",\"style\":{},\"className\":\"text-sm\"}]],\"style\":{},\"className\":\"flex flex-col m-auto text-center space-y-1 w-[33%]\"}],[\"$\",\"div\",null,{\"children\":[\"$\",\"a\",null,{\"href\":\"/\",\"children\":[\"$\",\"img\",null,{\"alt\":\"\",\"src\":\"../../assets/svg/user_icon.svg\",\"style\":{},\"className\":\"w-8 h-full m-auto group-hover:scale-110\"}]}],\"style\":{},\"className\":\"flex flex-col m-auto text-center space-y-1 w-[33%]\"}],[\"$\",\"div\",null,{\"children\":[[\"$\",\"a\",null,{\"href\":\"/shallow\",\"children\":\"shallow\",\"style\":{},\"className\":\"font-bold text-base\"}],[\"$\",\"a\",null,{\"href\":\"/deep\",\"children\":\"deep\",\"style\":{},\"className\":\"font-bold text-base\"}],[\"$\",\"a\",null,{\"href\":\"/me\",\"children\":\"me\",\"style\":{},\"className\":\"font-bold text-base\"}],[\"$\",\"a\",null,{\"href\":\"/dev/intro\",\"children\":\"dev\",\"style\":{},\"className\":\"font-bold text-base\"}]],\"style\":{},\"className\":\"flex m-auto space-x-4 w-[33%] justify-center\"}]],\"style\":{},\"className\":\"mx-auto max-w-[1080px] h-40 justify-between flex mobile:flex-col mobile:h-52\"}],\"style\":{}}]],\"style\":{},\"className\":\"mx-auto text-main max-w-[1080px]\"}]}]]}],null]],\"initialHead\":[false,\"$Lc\"],\"globalErrorComponent\":\"$d\"}]]\n"])</script><script>self.__next_f.push([1,"e:I[9275,[\"229\",\"static/chunks/229-125a0445ef9a59b1.js\",\"624\",\"static/chunks/624-820220bab49ef968.js\",\"606\",\"static/chunks/app/(pages)/deep/%5Bslug%5D/page-0f8f53d5c22a66de.js\"],\"MDXContent\"]\nf:I[2946,[\"229\",\"static/chunks/229-125a0445ef9a59b1.js\",\"624\",\"static/chunks/624-820220bab49ef968.js\",\"606\",\"static/chunks/app/(pages)/deep/%5Bslug%5D/page-0f8f53d5c22a66de.js\"],\"H2\"]\n10:I[2946,[\"229\",\"static/chunks/229-125a0445ef9a59b1.js\",\"624\",\"static/chunks/624-820220bab49ef968.js\",\"606\",\"static/chunks/app/(pages)/"])</script><script>self.__next_f.push([1,"deep/%5Bslug%5D/page-0f8f53d5c22a66de.js\"],\"A\"]\n11:I[2946,[\"229\",\"static/chunks/229-125a0445ef9a59b1.js\",\"624\",\"static/chunks/624-820220bab49ef968.js\",\"606\",\"static/chunks/app/(pages)/deep/%5Bslug%5D/page-0f8f53d5c22a66de.js\"],\"Strong\"]\n12:I[2946,[\"229\",\"static/chunks/229-125a0445ef9a59b1.js\",\"624\",\"static/chunks/624-820220bab49ef968.js\",\"606\",\"static/chunks/app/(pages)/deep/%5Bslug%5D/page-0f8f53d5c22a66de.js\"],\"Hr\"]\n13:I[2946,[\"229\",\"static/chunks/229-125a0445ef9a59b1.js\",\"624\",\"static/chunks/624-820220ba"])</script><script>self.__next_f.push([1,"b49ef968.js\",\"606\",\"static/chunks/app/(pages)/deep/%5Bslug%5D/page-0f8f53d5c22a66de.js\"],\"Img\"]\n14:I[2946,[\"229\",\"static/chunks/229-125a0445ef9a59b1.js\",\"624\",\"static/chunks/624-820220bab49ef968.js\",\"606\",\"static/chunks/app/(pages)/deep/%5Bslug%5D/page-0f8f53d5c22a66de.js\"],\"Li\"]\n15:I[2946,[\"229\",\"static/chunks/229-125a0445ef9a59b1.js\",\"624\",\"static/chunks/624-820220bab49ef968.js\",\"606\",\"static/chunks/app/(pages)/deep/%5Bslug%5D/page-0f8f53d5c22a66de.js\"],\"H3\"]\n"])</script><script>self.__next_f.push([1,"6:[\"$\",\"$Le\",null,{\"content\":[[\"$\",\"$Lf\",null,{\"children\":\"TossPayments\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[[\"$\",\"$L10\",null,{\"href\":\"https://namu.wiki/w/%EA%B2%B0%EC%A0%9C%EB%8C%80%ED%96%89%EC%82%AC\",\"children\":\"전자결제대행사\"}],\"\\r\\n(PG / Payment Gateway)는 이커머스 결제 지불 대행 서비스를 진행하는 중개업체를 이르는 말인데,\\r\\n\",[\"$\",\"$L11\",null,{\"children\":\"토스페이먼츠, KG이니시스, NHN KCP\"}],\" 이 3개 업체가 가장 높은 점유율을 차지한다.\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"나는 가장 점유율이 높고, 개발자센터를 통해 쉽고 간편하게 연동할 수 있는 토스페이먼츠를 사용해보기로 했다.\"}],\"\\n\",[\"$\",\"$L12\",null,{}],\"\\n\",[\"$\",\"$Lf\",null,{\"children\":\"결제 프로세스와 검증\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[[\"$\",\"$L13\",null,{\"src\":\"/posts/deep/tossPayments/toss_payments.png\",\"alt\":\"1\",\"title\":\"토스페이먼츠 결제 과정\"}],\"\\r\\n\",[\"$\",\"$L11\",null,{\"children\":\"토스페이먼츠\"}],\"(*이하토스)의 결제 과정은 다음과같다.\"]}],\"\\n\",[\"$\",\"br\",null,{}],\"\\n\",[\"$\",\"ol\",null,{\"children\":[\"\\n\",[\"$\",\"$L14\",null,{\"children\":\"토스페이먼츠에서 제공하는 결제위젯을 화면에 전시\"}],\"\\n\",[\"$\",\"$L14\",null,{\"children\":\"결제하기로 요청\"}],\"\\n\",[\"$\",\"$L14\",null,{\"children\":\"사용자 결제\"}],\"\\n\",[\"$\",\"$L14\",null,{\"children\":\"결제승인 API요청\"}],\"\\n\",[\"$\",\"$L14\",null,{\"children\":\"성공, 실패 Url로 리다이렉트\"}],\"\\n\"]}],\"\\n\",[\"$\",\"br\",null,{}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"이 일련의 과정속에서 가장 중요한건 MITM을 막고 데이터의 무결성을 훼손하지 않는일일 것이다.\"}],\"\\n\",[\"$\",\"$L12\",null,{}],\"\\n\",[\"$\",\"$Lf\",null,{\"children\":\"접근 방법\"}],\"\\n\",[\"$\",\"$L15\",null,{\"children\":\"1번 통신에 대한 접근\"}],\"\\n\",[\"$\",\"br\",null,{}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"1번에서 백엔드로 결제ID와 금액, 몇가지 구매정보를 보내 DB와 비교후 저장한다. 이를 통해 1차 가격변조를 막고 주문가능 상태를 한번 더 확인한다.\"}],\"\\n\",[\"$\",\"br\",null,{}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"[토스페이먼츠에서 제공하는 결제창 진입 직전에 백엔드와의 통신이 일어나지만, JWT만 있다면 포스트맨으로도 접근이 가능하다.]\"}],\"\\n\",[\"$\",\"br\",null,{}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"[결제ID를 현재시간 + 금액등을 조합해 Hash하여 백엔드로 보내 다시 검증한다면 포스트맨 등의 엔드포인트 접근을 막을 수 있을 것 같다.]\"}],\"\\n\",[\"$\",\"br\",null,{}],\"\\n\",[\"$\",\"$L15\",null,{\"children\":\"2번 통신에 대한 첫번째 접근\"}],\"\\n\",[\"$\",\"br\",null,{}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"1번에서 추가로 결제창 진입과 동시에 기존의 상품 갯수를 줄여놓고 페이지이탈(새로고침, 브라우저 닫기, 결제창 닫기 등)시\\r\\nbeforeunload과 sendBeacon을 통해 상품의 갯수를 롤백 하는 방식을 택하려 했으나, 브라우저 호환성이나 결제가 완료되고 리다이렉트 되는 경우에도 롤백하는 경우가 생긴다.\"}],\"\\n\",[\"$\",\"br\",null,{}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"[롤백이 될때 추가로 백엔드와 통신하게 되는데 만약 포스트맨으로 이 롤백을 실행한다면, 상품갯수를 줄이고 주문을 추가로 넣을 수 있다.]\"}],\"\\n\",[\"$\",\"br\",null,{}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"[1번과 동일하게 Hash하여 백엔드로 보내 1번에서 저장한 데이터와 비교한다고해도 DB원본에 대한 접근횟수가 너무 많아진다.]\"}],\"\\n\",[\"$\",\"br\",null,{}],\"\\n\",[\"$\",\"$L15\",null,{\"children\":\"2번 통신에 대한 두번째 접근\"}],\"\\n\",[\"$\",\"br\",null,{}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"2-1과 같은 문제를 해결하기 위해 롤백을 실행하는 일을 백엔드 자체에 맡길 수 있다. 1번에서 저장한 데이터에 status를 추가하여,\\r\\n결제가 완료를 판단 백엔드에서 1분간격으로 롤백을 진행하여 DB에 반영한다.\"}],\"\\n\",[\"$\",\"br\",null,{}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"[실시간성은 하락하고 백엔드의 부하는 늘어난다. 또 사실상 DB접근 빈도가 2-1보다 많을 가능성도 있다.]\"}],\"\\n\",[\"$\",\"br\",null,{}],\"\\n\",[\"$\",\"$L15\",null,{\"children\":\"2번 통신에 대한 세번째 접근\"}],\"\\n\",[\"$\",\"br\",null,{}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"가장 좋은 방법은 백엔드에게 결제를 맡기는 일이다. successUrl을 직접 백엔드 엔드포인트로 연결,\\r\\n구매정보비교 -\u003e 주문가능 상태 확인 -\u003e 상품 갯수 줄이기 -\u003e 결제 -\u003e 성공 / 실패시 롤백의 순으로 진행하면 된다.\\r\\nDB접근 횟수도 줄어들고, 실시간성도 보장된다.\"}],\"\\n\",[\"$\",\"br\",null,{}],\"\\n\",[\"$\",\"$L15\",null,{\"children\":\"3번 통신에 대한 접근\"}],\"\\n\",[\"$\",\"br\",null,{}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"결제 성공 여부를 토스에서 판단한 후 서버와 통신하기 때문에, 통신 탈취나 데이터 오염 위험이 적다. 다만, 성공 여부의 실시간 보장만이 중요해 보인다.\"}],\"\\n\",[\"$\",\"br\",null,{}],\"\\n\",[\"$\",\"$L15\",null,{\"children\":\"4번 통신에 대한 접근\"}],\"\\n\",[\"$\",\"br\",null,{}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"3번 통신과 동일, 실패 여부의 실시간 보장만이 중요해 보인다.\"}],\"\\n\",[\"$\",\"$L12\",null,{}],\"\\n\",[\"$\",\"$Lf\",null,{\"children\":\"최종 설계 모델\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"$\",\"$L13\",null,{\"src\":\"/posts/deep/tossPayments/toss_payments_arch.png\",\"alt\":\"2\",\"title\":\"토스페이먼츠 설계\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"2-3은 successUrl을 받은 후, 결제 승인 API를 호출하기 전에 서버에서 처리되므로 실시간성과 보안이 어느 정도 보장된다.\"}]],\"frontmatter\":{\"label\":\"Database\",\"title\":\"TossPayments의 대한 깊은 고찰\",\"subTitle\":\"결제는 몇번의 검증이 들어가야 좋을까?\",\"date\":\"2024.06.06\",\"mins\":20,\"tags\":[\"Toss\",\"TossPayments\",\"결제연동\",\"PG사\",\"보안\"],\"imageUrl\":\"/posts/deep/tossPayments/TossPayments_Logo_Primary_Reverse.png\"}}]\n"])</script><script>self.__next_f.push([1,"c:[[\"$\",\"meta\",\"0\",{\"name\":\"viewport\",\"content\":\"width=device-width, initial-scale=1\"}],[\"$\",\"meta\",\"1\",{\"charSet\":\"utf-8\"}],[\"$\",\"title\",\"2\",{\"children\":\"TossPayments의 대한 깊은 고찰\"}],[\"$\",\"meta\",\"3\",{\"name\":\"description\",\"content\":\"결제는 몇번의 검증이 들어가야 좋을까?\"}],[\"$\",\"link\",\"4\",{\"rel\":\"canonical\",\"href\":\"https://weaall.github.io/\"}],[\"$\",\"meta\",\"5\",{\"property\":\"og:title\",\"content\":\"Weaall's Dive\"}],[\"$\",\"meta\",\"6\",{\"property\":\"og:description\",\"content\":\"Weaall's pretty personal idea\"}],[\"$\",\"meta\",\"7\",{\"property\":\"og:url\",\"content\":\"https://weaall.github.io/\"}],[\"$\",\"meta\",\"8\",{\"property\":\"og:site_name\",\"content\":\"Weaall's Dive\"}],[\"$\",\"meta\",\"9\",{\"property\":\"og:locale\",\"content\":\"ko_KR\"}],[\"$\",\"meta\",\"10\",{\"property\":\"og:image\",\"content\":\"https://weaall.github.io/profile.png\"}],[\"$\",\"meta\",\"11\",{\"property\":\"og:image:alt\",\"content\":\"Weaall's Dive\"}],[\"$\",\"meta\",\"12\",{\"property\":\"og:image\",\"content\":\"https://weaall.github.io/another-image.jpg\"}],[\"$\",\"meta\",\"13\",{\"property\":\"og:image:alt\",\"content\":\"보조 이미지 설명\"}],[\"$\",\"meta\",\"14\",{\"property\":\"og:type\",\"content\":\"website\"}],[\"$\",\"meta\",\"15\",{\"name\":\"twitter:card\",\"content\":\"summary_large_image\"}],[\"$\",\"meta\",\"16\",{\"name\":\"twitter:title\",\"content\":\"Weaall's Dive\"}],[\"$\",\"meta\",\"17\",{\"name\":\"twitter:description\",\"content\":\"Weaall's pretty personal idea\"}],[\"$\",\"meta\",\"18\",{\"name\":\"twitter:image\",\"content\":\"https://weaall.github.io/profile.png\"}],[\"$\",\"meta\",\"19\",{\"name\":\"twitter:image:alt\",\"content\":\"Weaall's Dive\"}],[\"$\",\"meta\",\"20\",{\"name\":\"twitter:image\",\"content\":\"https://weaall.github.io/another-image.jpg\"}],[\"$\",\"meta\",\"21\",{\"name\":\"twitter:image:alt\",\"content\":\"보조 이미지 설명\"}],[\"$\",\"link\",\"22\",{\"rel\":\"icon\",\"href\":\"/favicon.ico\",\"type\":\"image/x-icon\",\"sizes\":\"16x16\"}]]\n"])</script><script>self.__next_f.push([1,"5:null\n"])</script><script>self.__next_f.push([1,""])</script></body></html>